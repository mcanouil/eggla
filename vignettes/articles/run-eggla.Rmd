---
title: "Run 'eggla' Workflow"
author: "Mickaël Canouil, *Ph.D.* (<mickael.canouil@cnrs.fr>)"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = FALSE
)
```

# Run Non-Interactively

1. Copy and edit the following code to a new file (_e.g._, `run_eggla.sh`) on the server that will run the analysis with the appropriate parameters.

  - `renv` (recommended):

    ```{bash, eval = FALSE}
    #!/bin/bash

    home_analysis="/tmp/egg_analysis" # to be changed to the folder in which "egg_analysis" is to be performed

    mkdir $home_analysis 

    cd $home_analysis || exit

    R --no-save --no-restore --quiet <<EOF
    temp_library <- file.path(".", "R")
    dir.create(temp_library, recursive = TRUE)
    .libPaths(temp_library)
    install.packages("renv", lib = temp_library, repos = "http://cloud.r-project.org")
    library("renv")
    renv::init(bare = TRUE, settings = list(use.cache = FALSE))
    utils::download.file(
        url = "https://raw.githubusercontent.com/mcanouil/eggla/v0.7.0/inst/setup/renv.lock",
        destfile = "renv.lock"
      )
    renv::restore(lockfile = "renv.lock")
    renv::install("mcanouil/eggla@v0.7.0")
    unlink(temp_library, recursive = TRUE)
    EOF

    R --no-save --no-restore --quiet <<EOF
    library(eggla)
    library(data.table)
    res <- try(run_eggla(
      data = fread("/tmp/bmigrowth.csv"), # to be changed with the path of the file containing the data
      id_variable = "ID",
      age_days_variable = NULL, # computed based on "age_years_variable" if not provided. Only used for QC.
      age_years_variable = "age", 
      weight_kilograms_variable = "weight",
      height_centimetres_variable = "height",
      sex_variable = "sex",
      covariates = NULL,
      male_coded_zero = FALSE,
      random_complexity = "auto",
      use_ar1 = FALSE,
      parallel = FALSE, # to parallelise Daymont QC
      parallel_n_chunks = 1, # to parallelise Daymont QC
      working_directory = "." # or in that case "/tmp/egg_analysis"
    ))
    if (inherits(res, "try-error")) unlink(wd, recursive = TRUE)
    EOF

    ```

  - `pak` (faster):

    ```{bash, eval = FALSE}
    #!/bin/bash

    home_analysis="/tmp/egg_analysis" # to be changed to the folder in which "egg_analysis" is to be performed

    mkdir $home_analysis 

    cd $home_analysis || exit

    R --no-save --no-restore --quiet <<EOF
    temp_library <- file.path(".", "R")
    dir.create(temp_library, recursive = TRUE)
    .libPaths(temp_library)
    utils::install.packages(
      pkgs = "pak",
      lib = temp_library,
      repos = sprintf(
        "https://r-lib.github.io/p/pak/stable/%s/%s/%s",
        .Platform[["pkgType"]], R.Version()[["os"]], R.Version()[["arch"]]
      )
    )
    library(pak)
    utils::download.file(
      url = "https://raw.githubusercontent.com/mcanouil/eggla/v0.7.0/inst/setup/pkg.lock",
      destfile = "pkg.lock"
    )
    lockfile_install(lockfile = "pkg.lock", lib = temp_library)
    pkg_install("mcanouil/eggla@v0.7.0", lib = temp_library, upgrade = FALSE, dependencies = FALSE)
    EOF
    
    R --no-save --no-restore --quiet <<EOF
    library(eggla)
    library(data.table)
    res <- try(run_eggla(
      data = fread("/tmp/bmigrowth.csv"), # to be changed with the path of the file containing the data
      id_variable = "ID",
      age_days_variable = NULL, # computed based on "age_years_variable" if not provided. Only used for QC.
      age_years_variable = "age", 
      weight_kilograms_variable = "weight",
      height_centimetres_variable = "height",
      sex_variable = "sex",
      covariates = NULL,
      male_coded_zero = FALSE,
      random_complexity = "auto",
      use_ar1 = FALSE,
      parallel = FALSE, # to parallelise Daymont QC
      parallel_n_chunks = 1, # to parallelise Daymont QC
      working_directory = "." # or in that case "/tmp/egg_analysis"
    ))
    if (inherits(res, "try-error")) unlink(wd, recursive = TRUE)
    EOF

    ```

2.  Run the analysis in bash

    ```{bash, eval = FALSE}
    bash run_eggla.sh
    ```

3. Retrieve the two archives

    ```
    /tmp/egg_analysis/
    ├── 2021-11-23-female.zip
    └── 2021-11-23-male.zip
    ```

4. Run the GWASs on slopes and AUCs for male and female

    ```{bash, eval = FALSE}
    #!/bin/bash

    home_analysis="/tmp/egg_analysis" # to be changed to the folder in which "egg_analysis" is to be performed

    mkdir $home_analysis

    cd $home_analysis || exit

    R --no-save --no-restore --quiet <<EOF
    library(eggla)
    chr_in_parallel <- FALSE # or 11 to run 11 chromosomes in 11 processes/cores
    if (!isFALSE(chr_in_parallel)) {
      renv::install(c("future", "future.apply"))
      future::plan("multicore", workers = min(chr_in_parallel, future::availableCores()))
    }
    do_eggla_gwas(
      data = "/tmp/bmigrowth.csv",
      list.files(path = ".", pattern = "\\\\.zip", full.names = TRUE),
      id_column = "ID",
      traits = c("slope_.*", "auc_.*"),
      covariates = c("sex"),
      vcfs = list.files(path = file.path(".", "vcf"), pattern = "\\\\.vcf$|\\\\.vcf.gz$", full.names = TRUE),
      vep = NULL,
      path = ".",
      bin_path = list(
        bcftools = "/usr/bin/bcftools",
        plink2 = "https://s3.amazonaws.com/plink2-assets/plink2_linux_x86_64_20220410.zip"
      ),
      threads = 1
    )
    EOF

    ```


# Run Interactively

1. Create the working directory

    ```{bash, eval = FALSE}
    home_analysis="/tmp/egg_analysis" # to be changed to the folder in which "egg_analysis" is to be performed
    
    mkdir $home_analysis 

    cd $home_analysis || exit
    ```

2. Start R and setup working directory using `renv` (recommended) or `pak` (faster) to restore predefined version of packages

  - `renv` (recommended):

    ```{r, eval = FALSE}
    temp_library <- file.path(".", "R")
    dir.create(temp_library, recursive = TRUE)
    .libPaths(temp_library)
    install.packages("renv", lib = temp_library, repos = "http://cloud.r-project.org")
    library("renv")
    renv::init(bare = TRUE, settings = list(use.cache = FALSE))
    utils::download.file(
      url = "https://raw.githubusercontent.com/mcanouil/eggla/v0.7.0/inst/setup/renv.lock",
      destfile = "renv.lock"
    )
    renv::restore(lockfile = "renv.lock")
    renv::install("mcanouil/eggla@v0.7.0")
    unlink(temp_library, recursive = TRUE)
    ```

  - `pak` (faster):

    ```{r, eval = FALSE}
    temp_library <- file.path(".", "R")
    dir.create(temp_library, recursive = TRUE)
    .libPaths(temp_library)
    utils::install.packages(
      pkgs = "pak",
      lib = temp_library,
      repos = sprintf(
        "https://r-lib.github.io/p/pak/stable/%s/%s/%s",
        .Platform[["pkgType"]], R.Version()[["os"]], R.Version()[["arch"]]
      )
    )
    library(pak)
    utils::download.file(
      url = "https://raw.githubusercontent.com/mcanouil/eggla/v0.7.0/inst/setup/pkg.lock",
      destfile = "pkg.lock"
    )
    lockfile_install(lockfile = "pkg.lock", lib = temp_library)
    pkg_install("mcanouil/eggla@0.7.0", lib = temp_library, upgrade = FALSE, dependencies = FALSE)
    ```

3. Restart R

4. Run the analysis

    ```{r, eval = FALSE}
    library(eggla)
    library(data.table)
    res <- try(
      run_eggla(
        data = fread("/tmp/bmigrowth.csv"),
        id_variable = "ID",
        age_days_variable = NULL,
        age_years_variable = "age",
        weight_kilograms_variable = "weight",
        height_centimetres_variable = "height",
        sex_variable = "sex",
        covariates = NULL,
        male_coded_zero = FALSE,
        random_complexity = "auto",
        use_ar1 = FALSE,
        parallel = FALSE,
        parallel_n_chunks = 1,
        working_directory = "."
      )
    )
    if (inherits(res, "try-error")) unlink(wd, recursive = TRUE)
    ```

5. Retrieve the two archives

    ```
    /tmp/egg_analysis/
    ├── 2021-11-23-female.zip
    └── 2021-11-23-male.zip
    ```

6. Run the GWASs on slopes and AUCs for male and female

    ```{r, eval = FALSE}
    library(eggla)
    chr_in_parallel <- FALSE # or 11 to run 11 chromosomes in 11 processes/cores
    if (!isFALSE(chr_in_parallel)) {
      renv::install(c("future", "future.apply"))
      future::plan("multicore", workers = min(chr_in_parallel, future::availableCores()))
    }
    do_eggla_gwas(
      data = "/tmp/bmigrowth.csv",
      results_zip = list.files(path = ".", pattern = "\\.zip", full.names = TRUE),
      id_column = "ID",
      traits = c("slope_.*", "auc_.*"),
      covariates = c("sex"),
      vcfs = list.files(
        path = file.path(".", "vcf"),
        pattern = "\\.vcf$|\\.vcf.gz$",
        full.names = TRUE
      ),
      vep = NULL,
      path = ".",
      bin_path = list(
        bcftools = "/usr/bin/bcftools",
        plink2 = "https://s3.amazonaws.com/plink2-assets/plink2_linux_x86_64_20220410.zip"
      ),
      threads = 1
    )
    ```
